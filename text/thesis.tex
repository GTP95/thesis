\documentclass{report}

\usepackage{biblatex}
\usepackage{dsfont}
\usepackage{mathtools}

\addbibresource{bibliography.bib}

\begin{document}

\title{Designing and implementing a participant login solution for PEP using IRMA}
\author{Giacomo Tommaso Petrucci}
\maketitle

\begin{abstract}
	Polymorphic Encryption and Pseudonymization (PEP) is a project developed at iHub to let researcher collect medical data of people taking part in studies, while preserving their 
	privacy. To do so, it uses ElGamal cipher's properties that allow to re-key and re-shuffle encrypted data. While this system effectively safeguards a participant's privacy, it 
	also makes it non-trivial to design a way for the participants to access their own data: due to PEP's privacy goals, the typical login with username and password is out of
	question. 
\end{abstract}

\section{Introduction}
Polymorphic encryption and pseudonymisation (PEP) is a secure data repository that uses the ElGamal cipher to store data in encrypted form. Thanks to
ElGamal's re-key operation, it is possible to store the data by an untrusted party and even before knowing who will need to get access to the data. Then the data
can be subsequently re-keyed to grant access to the intended person or entity, without exposing the plaintext to the storage provider. An entity might need a global identifier for
the people whose data is stored inside PEP, or to store an already existing identifier but without accessing the original identifier. To solve this problem, PEP uses ElGamal's
re-shuffle operation, that lets derive many identifiers from a "base identifier" without disclosing that base identifier \cite{peppaper}. 
PEP's current focus is healthcare, but its general architecture can be used for different purposes. The NOLAI \cite{nolai} [project? Institute?] recently announced that it will use PEP to
collect their research data. \linebreak
A side effect of PEP's privacy focus is that it didn't ship with a way for study participants, or people whose data is stored inside PEP in general, to get access to their own data.
This work is aimed at finding and developing a solution to this issue.

\section{An introduction to PEP's internals}
At the heart of PEP's design, are ElGamal's re-key and re-shuffle operations. To this cryptographic foundation, other elements are added to get a complete functional system. In
particular, PEP uses a form of rule-based access control (RBAC) to manage users' privileges. It also employs hybrid cryptography for performance reasons. This section will first
present a quick recap of ElGamal cipher and in particular of the re-key and re-shuffle operations. Then it will briefly discuss PEP's design and focus on PEP's way to manage users'
privileges.

\subsection{ElGamal recap}
ElGamal is a public key cryptosystem based on the hardness of computing discrete logarithms \cite{elgamal}. It was originally devised to work on Galois fields, but it has since
been adapted to work on elliptic curves. As PEP uses the latter version, this is the one that will be presented here. Assume Alice would like to send an encrypted message to Bob. First, Bob has to
generate a keypair in the following way. He starts by choosing a prime number $p$, such that $p-1$ has at least one large prime factor. Then he picks a generator $g$ for
the field $\mathds{F}_q$. Now he has to generate a uniformly random value $x_b \in \mathds{F}_q$ and compute $y_b=g^{x_b} \mod q$. $x_b$ is Bob's private key and $y_b$ is Bob's
public key.\\
We can now assume that Alice's message $m$ is such that $0 \leq m \leq q-1$. If this is not the case, Alice can split her message in $N \in \mathds{N}$ blocks such that $\forall n
\leq N, 0 \leq m_n \leq q-1 $ and encrypt those separately. Now Alice first generates a uniformly random value $K \in \mathds{F}_q$, and then computes $K \equiv y_b^K \mod p$. She can
then encrypt her message by computing 

$$c_1 \equiv a^K \mod p$$
$$c_2 \equiv km \mod p$$

The ciphertext is the pair $(c_1, c_2)$. \\

Bob can decrypt the message by computing

$$K \equiv c_1^{x_b} \mod p$$
$$m \equiv c_2K^{-1} \mod p$$

\subsubsection{homomorphic properties}
ElGamal is homomorphic with regards to exponentiation. 

\section{How to give access to study participants}
\subsection{Some initial ideas}
The first idea to let users download their data from PEP was to use IRMA to disclose the data needed to generate the pseudonym to some component that then proceeds to generate it.
This doesn't work because the pseudonym is generated by encrypting a random string. But this string gets stored inside Salesforce, so the next idea was to interface with
Salesforce. This could have posed some issues though:
\begin{enumerate}
		\item Is the seed stored along some data that uniquely identifies the user?
		\item Does Salesforce have some API to interface with other software?
\end{enumerate}
Let's analyze these issues. If the seed is stored alongside personal data, then getting it from Salesforce could expose personal identifiable information. How? One could argue that
they shouldn't store anything inside Salesforce anyway... But it is done to be able to de-anonymize users in special circumstances. And here we get to the point: better not touch
Salesforce, unless those special circumstances arise. The second issue is about API access. Salesforce does have it, but only for certain editions \cite{salesforce}. The PEP team
blackballed the idea of accessing Salesforce. The next proposal was to give participants their own ID (main pseudonym) during the enrollment procedure as an IRMA credential, but
providing them with this ID could disclose more information than necessary.
Since this first idea was discarded, I considered the following approaches:
\begin{enumerate}
		\item Give participants their own ID during enrollment phase.
		\item Give participants a re-shuffled ID.
		\item Create a fake study in which the participant has the researcher role.
		\item Use IRMAâ€™s chained session: it is possible to derive a card from other cards the user already has by having the user disclose he attributes contained there. The server can then apply some function on the attributes and derive a new card from that.
\end{enumerate}

The first approach could pose unnecessary risks. The participant's pseudonym is used to obtain the re-shuffled pseudnyms that identify the participant in different studies and in
different datasets. To be able to derive these pseudonyms, an attacker would also need to get the re-shuffle key, but not leaking the pseudonym outside of PEP in the first place would still be
better. \\
The second approach would solve the problem of leaking the participant's pseudonym, but participants would still need to be provided with some key material to ab able to decrypt
the data once downloaded. [Is this true though? Couldn't this just work the same as I have it implemented now?]. \\
In a similar fashion to the previous approach, it would be possible to create a fake study inside PEP with a single participant, one for each user. Then the users would be given
the researcher role inside their own fake study to be able to access their own data. Also this option would require to provide them with some key material, opening the door to keym
management issues [again, is this actually needed? See also previous note]. \\
The last approach is a way to sidestep the issue of providing study participants with their own pseudonym or a re-shuffled pseudonym. But it would require some way of linking the
IRMA identity to the participant.\\

\subsection{The chosen solution}
PEP uses rbac, let's use that too! First, create a column group containing all the columns pertaining to exam results. Then, for each participant, create a new participant group
containing only that participant. Create a new user and apply permissions as needed. And SBAM! You've got it! [Insert here actual participant enrollment procedure and provide
details].
\subsection{The pain of implementing the solution}

\printbibliography
\end{document}
